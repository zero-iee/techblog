<!doctype html><html lang=de data-theme=dark><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>Die Wireguard VPN Firewall mit Shorewall übersichtlich halten - ZERO GmbH Tech Blog</title>
<meta name=description content="In unserem vorherigen Artikel haben wir die iptables-Firewall für unseren Wireguard VPN-Server vorgestellt. Die Firewall regelt, welcher Traffic zwischen den einzelnen Kunden-VPNs und dem Management-VPN erlaubt ist und verhindert Zugriffe, die ein Sicherheitsrisiko darstellen.
Die Verwaltung dieser Regeln mittels der iptables Command Line Tools ist zwar möglich, allerdings relativ schnell unübersichtlich und insbesondere für Außenstehende schwer zu erfassen. Wir haben deshalb die Firewallkonfiguration über das Tool &ldquo;Shorewall&rdquo; erprobt und für geeignet befunden."><link rel=icon type=image/x-icon href=https://blog.zero-iee.com/favicon.ico><link rel=apple-touch-icon-precomposed href=https://blog.zero-iee.com/favicon.png><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><script defer data-domain=blog.zero-iee.com src=https://analytics.zero-iee.com/js/script.js></script><link rel=stylesheet href=https://blog.zero-iee.com/css/style.min.930d4b2abd5c36f0b4decc538651a976d4e2c8f2f5c29312c354f3ca383468ae.css integrity="sha256-kw1LKr1cNvC03sxThlGpdtTiyPL1wpMSw1Tzyjg0aK4="><script src=https://blog.zero-iee.com/js/script.min.74bf1a3fcf1af396efa4acf3e660e876b61a2153ab9cbe1893ac24ea6d4f94ee.js type=text/javascript integrity="sha256-dL8aP88a85bvpKzz5mDodrYaIVOrnL4Yk6wk6m1PlO4="></script><meta property="og:url" content="https://blog.zero-iee.com/posts/vpn-firewall-shorewall/"><meta property="og:site_name" content="ZERO GmbH Tech Blog"><meta property="og:title" content="Die Wireguard VPN Firewall mit Shorewall übersichtlich halten"><meta property="og:description" content="In unserem vorherigen Artikel haben wir die iptables-Firewall für unseren Wireguard VPN-Server vorgestellt. Die Firewall regelt, welcher Traffic zwischen den einzelnen Kunden-VPNs und dem Management-VPN erlaubt ist und verhindert Zugriffe, die ein Sicherheitsrisiko darstellen.
Die Verwaltung dieser Regeln mittels der iptables Command Line Tools ist zwar möglich, allerdings relativ schnell unübersichtlich und insbesondere für Außenstehende schwer zu erfassen. Wir haben deshalb die Firewallkonfiguration über das Tool “Shorewall” erprobt und für geeignet befunden."><meta property="og:locale" content="de"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-04T08:41:52+01:00"><meta property="article:modified_time" content="2023-12-04T08:41:52+01:00"><meta property="article:tag" content="Wireguard"><meta property="article:tag" content="Vpn"><meta property="article:tag" content="Shorewall"><meta property="article:tag" content="Firewall"><meta property="article:tag" content="Iptables"><meta name=twitter:card content="summary"><meta name=twitter:title content="Die Wireguard VPN Firewall mit Shorewall übersichtlich halten"><meta name=twitter:description content="In unserem vorherigen Artikel haben wir die iptables-Firewall für unseren Wireguard VPN-Server vorgestellt. Die Firewall regelt, welcher Traffic zwischen den einzelnen Kunden-VPNs und dem Management-VPN erlaubt ist und verhindert Zugriffe, die ein Sicherheitsrisiko darstellen.
Die Verwaltung dieser Regeln mittels der iptables Command Line Tools ist zwar möglich, allerdings relativ schnell unübersichtlich und insbesondere für Außenstehende schwer zu erfassen. Wir haben deshalb die Firewallkonfiguration über das Tool “Shorewall” erprobt und für geeignet befunden."></head><body><a class=skip-main href=#main>Zum Hauptinhalt springen</a><div class=container><header class=common-header><div class=header-top><div class=header-logo></div><h1 class=site-title><a href=/>ZERO GmbH Tech Blog</a></h1><ul class=social-icons><li><a href=https://techhub.social/@zeroiee title=Mastodon rel=me><span class=inline-svg><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></span></a></li><li><a href=https://github.com/zero-iee title=Github rel=me><span class=inline-svg><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></li><li><a href=https://de.linkedin.com/company/zero-iee title=Linkedin rel=me><span class=inline-svg><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></a></li></ul></div><nav></nav></header><main id=main tabindex=-1><article class="post h-entry"><div class=post-header><header><h1 class="p-name post-title">Die Wireguard VPN Firewall mit Shorewall übersichtlich halten</h1><span><ul class=post-translations><li>DE</li><li><a href=https://blog.zero-iee.com/en/posts/vpn-firewall-shorewall/>EN</a></li></ul></span></header></div><div class="content e-content"><p>In unserem <a href=/posts/multi-tenant-wireguard-vpn-server/>vorherigen Artikel</a> haben wir die iptables-Firewall für unseren Wireguard VPN-Server vorgestellt. Die Firewall regelt, welcher Traffic zwischen den einzelnen Kunden-VPNs und dem Management-VPN erlaubt ist und verhindert Zugriffe, die ein Sicherheitsrisiko darstellen.</p><p>Die Verwaltung dieser Regeln mittels der iptables Command Line Tools ist zwar möglich, allerdings relativ schnell unübersichtlich und insbesondere für Außenstehende schwer zu erfassen. Wir haben deshalb die Firewallkonfiguration über das Tool &ldquo;<a href=https://shorewall.org/>Shorewall</a>&rdquo; erprobt und für geeignet befunden.</p><p>Shorewall ist ein Tool, das einfache Textdateien mit Firewallregeln nach einem vordefinierten Format einliest, validiert und in iptables-Regeln umsetzt. Es ist also nur ein Frontend, das iptables bedient und keine eigenständige Firewall im engeren Sinne.</p><p>Durch die statische Konfiguration in einzelnen semantisch getrennten Textdateien fällt es leichter, den Überblick zu behalten. Iptables-Regeln können zwar via netfilter-persistent (bzw. iptables-persistent) ebenfalls in Textdateien persistiert werden, doch die Syntax ist beim Überfliegen nur schwer verständlich. Für kleinere Setups mag das ausreichen - doch wir planen einige VPN-Netze u.A. mit individuellen Berechtigungen aufzuspannen. Mit Shorewall als iptables-Konfigurator können wir die Übersicht über die Firewallregeln besser behalten und Fehler vermeiden.</p><p>Die Firewallkonfiguration verteilt sich bei Shorewall über einige Dateien im Konfigurationsverzeichnis <code>/etc/shorewall</code>:</p><ul><li><code>/etc/shorewall/zones</code>: Definiert die Firewall-Zonen, die später in den Regelsätzen verwendet werden können.</li><li><code>/etc/shorewall/interfaces</code>: Regelt, welche Netzwerk-Interfaces mit Shorewall benutzt werden sollen und welchen Zone sie angehören.</li><li><code>/etc/shorewall/policy</code>: Definiert die Default-Policies zwischen Zonen. Darf Traffic zwischen Zonen passieren oder nicht?</li><li><code>/etc/shorewall/rules</code>: Hier werden die feingranularen Regeln definiert: Wurde vorher beispielsweise eine <code>REJECT</code> Policy zwischen Zonen definiert, können hier port-/protokoll-basierte Ausnahmen definiert werden.</li></ul><p>Im Folgenden werfen wir einen Blick in unsere Konfiguration:</p><p><code>zones</code>:</p><pre tabindex=0><code>fw              firewall
wan             ipv4
customer1-vpn   ipv4
customer1-vpn   ipv4
mastervpn       ipv4
</code></pre><p>Wir legen Zone <code>fw</code> (Alias: <code>$FW</code>) als Firewall-eigene Zone fest und definieren weitere Zonen für unsere WAN Schnittstelle und unsere VPN-Netze.</p><p><code>interfaces</code>:</p><pre tabindex=0><code>wan             eth0            detect                  dhcp,routefilter,tcpflags

customer1-vpn   customer1-vpn   detect                  routeback
customer2-vpn   customer2-vpn   detect                  routeback
mastervpn       mastervpn       detect                  routeback
</code></pre><p>Hier werden Netzwerkinterface und Zone miteinander verknüpft - die Zone in der ersten Spalte, das zugeordnete Netzwerkinterface in der zweiten Spalte. Besonders wichtig ist bei den VPN-Zonen die <code>routeback</code> Option, die dafür sorgt, dass Traffic, der an einem VPN-Interface eingeht, selbiges auch direkt wieder verlassen kann; so wie es bei einem VPN-Interface die Regel ist, wenn Clients miteinander kommunizieren. Später wird diese Client-to-Client Kommunikation zwar wieder deaktiviert, aber wir wollen uns die Möglichkeit vorhalten, sie für einzelne VPN-Clients zu ermöglichen.</p><p><code>policy</code>:</p><pre tabindex=0><code># Source        # Dest  # Policy
wan             all     REJECT
$FW             all     ACCEPT

mastervpn       all     ACCEPT
customer1-vpn   all     REJECT
customer2-vpn   all     REJECT
</code></pre><p>Eingehender Traffic auf WAN soll grundsätzlich erst einmal blockiert werden. Einzelne Ausnahmen - beispielsweise für die VPN-Server-Ports - werden später in der <code>rules</code> Datei gemacht.</p><p>Die Firewall selbst bekommt keine Einschränkungen und darf andere Zonen bzw. Interfaces beliebig ansprechen.</p><p>Unser <code>mastervpn</code> darf ebenfalls uneingeschränkt kommunizieren. Dabei handelt es sich um das Admin-Interface, von dem aus unsere Entwickler Verbindungen zu verschiedenen VPN-Clients herstellen.</p><p>Restriktiver gehen wir bei den beiden Kunden-VPNs <code>customer1-vpn</code> und <code>customer2-vpn</code> vor: Diese werden mittels <code>REJECT</code> eingesperrt und dürfen per default erst einmal mit niemandem kommunizieren.</p><p><code>rules</code>: Nun folgen die Ausnahmen für die gerade erklärten Policies:</p><pre tabindex=0><code># Policy        # Source        # Dest  # Prot  # Port

# Allow access to VPN ports
ACCEPT          wan             $FW     UDP     51821,51822,51823

# Allow SSH from internet
SSH(ACCEPT)     wan             $FW

# Allow pings from all VPNs to their Server VPN interface
Ping(ACCEPT)    customer1-vpn        $FW:10.2.1.1
Ping(ACCEPT)    customer2-vpn        $FW:10.3.0.1
Ping(ACCEPT)    mastervpn            $FW:10.4.0.1

# Explicitly allow inter-client connections on some VPN devices (legacy &#34;admin&#34; devices)
ACCEPT          customer1-vpn:10.2.1.10    customer1-vpn      # device 1
ACCEPT          customer1-vpn:10.2.1.11    customer1-vpn      # device 2
ACCEPT          customer1-vpn:10.2.1.12    customer1-vpn      # device 3

# Prevent inter-client connections on VPNs for all devices that have not explicitly been allowed in the section before
REJECT          customer1-vpn        customer1-vpn:10.2.1.0/24
REJECT          customer2-vpn        customer2-vpn:10.3.0.0/16
</code></pre><p>Zuerst wird der Zugriff auf die WAN Ports <code>51821,51822,51823</code> erlaubt, sodass sich Wireguard-VPN Clients zum VPN Server verbinden können. Außerdem verbinden wir uns über SSH zum VPN-Server - auch das soll weiterhin erlaubt bleiben. In diesem Fall nutzen wir das <code>SSH(ACCEPT)</code> Makro von Shorewall, um Port und Protokoll nicht gesondert definieren zu müssen.</p><p>Pings von VPN-Clients zu deren jeweiligen serverseitigen Interface und seiner IP-Adressen sollen in allen Fällen erlaubt sein. Wir pingen in der Regel das Serverinterface an, um die Funktionsfähigkeit einer VPN-Verbindung festzustellen.</p><p>Im nächsten Abschnitt wird Client-to-Client Kommunikation für einzelne VPN-Clients des Netzes <code>customer1-vpn</code> explizit ermöglicht.</p><p>&mldr; für alle anderen Geräte wird diese Art der Kommunikation im darauf folgenden Abschnitt mittels <code>REJECT</code> verhindert. Sie können folglich nur Antwortpakete zurückschicken (implizite Regel in Shorewall) und nicht von sich aus Verbindungen initiieren.</p><p>IP-Forwarding ist auf unserem Server bereits aktiviert. Wer die Einstellung <code>net.ipv4.ip_forward</code> in /etc/sysctl.conf noch nicht aktiviert hat, kann stattdessen auch in <code>/etc/shorewall/shorewall.conf</code> <code>IP_FORWARDING</code> auf <code>On</code> setzen.</p><p>Zum Schluss haben wir <code>netfilter-persistent</code> aus dem Boot genommen:</p><pre><code>systemctl disable netfilter-persistent
</code></pre><p>&mldr; und die iptables-Regeln geleert:</p><pre><code>iptables -F
</code></pre><p>&mldr; um dann die neuen Shorewall-Regeln testen zu können:</p><pre><code>shorewall start
</code></pre><p>Nachdem alles wie erhofft funktioniert hat, wurde Shorewall in den Autostart aufgenommen:</p><pre><code>systemctl enable shorewall
</code></pre></div><div class=post-info>Von Thomas Leister<div class="post-date dt-published">2023-12-04</div><a class="post-hidden-url u-url" href=https://blog.zero-iee.com/posts/vpn-firewall-shorewall/>https://blog.zero-iee.com/posts/vpn-firewall-shorewall/</a>
<a href=https://blog.zero-iee.com/ class="p-name p-author post-hidden-author h-card" rel=me>Thomas Leister</a><div class=post-taxonomies><ul class=post-tags><li><a href=https://blog.zero-iee.com/tags/wireguard/>#Wireguard</a></li><li><a href=https://blog.zero-iee.com/tags/vpn/>#Vpn</a></li><li><a href=https://blog.zero-iee.com/tags/shorewall/>#Shorewall</a></li><li><a href=https://blog.zero-iee.com/tags/firewall/>#Firewall</a></li><li><a href=https://blog.zero-iee.com/tags/iptables/>#Iptables</a></li></ul></div></div></article></main><footer class=common-footer><ul class=language-select><li>Deutsch</li><li><a href=https://blog.zero-iee.com/en/posts/vpn-firewall-shorewall/>English</a></li></ul><div class=common-footer-bottom><div class=copyright><p>© ZERO GmbH, ZERO GmbH Team, 2024 | <a href=/impressum/>Impressum</a> | <a href=/datenschutz/>Datenschutz</a><br>Erstellt mit <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>, Markdown and Git<br>Theme <a target=_blank rel="noopener noreferrer" href=https://github.com/zero-iee/hugo-theme-anubis-zero>Anubis ZERO</a> basierend auf <a href=https://github.com/Mitrichius/hugo-theme-anubis>Mitrichius/hugo-theme-anubis</a>.<br></p></div><script>const STORAGE_KEY="user-color-scheme",defaultTheme="dark-without-switcher";let currentTheme,switchButton,autoDefinedScheme=window.matchMedia("(prefers-color-scheme: dark)");const autoChangeScheme=e=>{currentTheme=e.matches?"dark":"light",document.documentElement.setAttribute("data-theme",currentTheme),changeButtonText()};document.addEventListener("DOMContentLoaded",function(){switchButton=document.querySelector(".theme-switcher"),currentTheme=detectCurrentScheme(),currentTheme=="dark"&&document.documentElement.setAttribute("data-theme","dark"),currentTheme=="auto"&&(autoChangeScheme(autoDefinedScheme),autoDefinedScheme.addListener(autoChangeScheme)),switchButton&&(changeButtonText(),switchButton.addEventListener("click",switchTheme,!1)),showContent()});function detectCurrentScheme(){return localStorage.getItem(STORAGE_KEY)?localStorage.getItem(STORAGE_KEY):defaultTheme?defaultTheme:window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":"light"}function changeButtonText(){switchButton&&(switchButton.textContent=currentTheme=="dark"?"Helles Theme":"Dunkles Theme")}function switchTheme(){currentTheme=="dark"?(localStorage.setItem(STORAGE_KEY,"light"),document.documentElement.setAttribute("data-theme","light"),currentTheme="light"):(localStorage.setItem(STORAGE_KEY,"dark"),document.documentElement.setAttribute("data-theme","dark"),currentTheme="dark"),changeButtonText()}function showContent(){document.body.style.visibility="visible",document.body.style.opacity=1}</script></div><p class="h-card vcard"><a href=https://blog.zero-iee.com/ class="p-name u-url url fn" rel=me>ZERO GmbH Team</a></p></footer><a rel=me href=https://techhub.social/@zeroiee style=display:none>Mastodon</a></div></body></html>