<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Systemd on ZERO GmbH Tech Blog</title><link>https://blog.zero-iee.com/en/tags/systemd/</link><description>ZERO GmbH Tech Blog (Systemd)</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Fri, 06 Sep 2024 17:33:54 +0200</lastBuildDate><atom:link href="https://blog.zero-iee.com/en/tags/systemd/index.xml" rel="self" type="application/rss+xml"/><item><title>Dnsmasq does not start because port 53 is busy</title><link>https://blog.zero-iee.com/en/posts/dnsmasq-startup-error-with-systemd-resolved/</link><pubDate>Fri, 06 Sep 2024 17:33:54 +0200</pubDate><guid>https://blog.zero-iee.com/en/posts/dnsmasq-startup-error-with-systemd-resolved/</guid><description>&lt;p>Perhaps some of you have already run into this problem when Dnsmasq was to be used as a separate DNS/DHCP server on a host with an extra network interface:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ sudo systemctl status dnsmasq
[...]
Sep 06 14:32:22 office-gateway dnsmasq[830]: failed to create listening socket for port 53: Address already in use
Sep 06 14:32:22 office-gateway dnsmasq[830]: FAILED to start up
Sep 06 14:32:22 office-gateway systemd[1]: dnsmasq.service: Control process exited, code=exited, status=2/INVALIDARGUMENT
Sep 06 14:32:22 office-gateway systemd[1]: dnsmasq.service: Failed with result &amp;#39;exit-code&amp;#39;.
Sep 06 14:32:22 office-gateway systemd[1]: Failed to start dnsmasq.service - dnsmasq - A lightweight DHCP and caching DNS server.
[...]
&lt;/code>&lt;/pre>&lt;p>The cause was - we thought - quickly clear to us, because the Ubuntu server system in question is already equipped with the local &lt;code>systemd-resolved&lt;/code> resolver, which already performs excellently on port 53. The Dnsmasq service, which in addition to DHCP also wants to offer a DNS service on port 53, can no longer hijack the port.&lt;/p>
&lt;p>We thought that we could avoid the problem by making an exception for the network interfaces, because interfaces that should be ignored can be specified for Dnsmasq via &lt;code>except-interface&lt;/code>. File &lt;code>/etc/dnsmasq.conf&lt;/code>:&lt;/p>
&lt;pre tabindex="0">&lt;code>except-interface=lo
&lt;/code>&lt;/pre>&lt;p>But that didn&amp;rsquo;t help. The problem still persisted.&lt;/p>
&lt;p>Finally, we found an option in &lt;code>/etc/defaults/dnsmasq&lt;/code> that causes Dnsmasq to ignore all local interfaces:&lt;/p>
&lt;pre tabindex="0">&lt;code># If the resolvconf package is installed, dnsmasq will tell resolvconf
# to use dnsmasq under 127.0.0.1 as the system&amp;#39;s default resolver.
# Uncommenting this line inhibits this behaviour.
DNSMASQ_EXCEPT=&amp;#34;lo&amp;#34;
&lt;/code>&lt;/pre>&lt;p>The option must be commented in - as shown - for it to become active. After restarting the &lt;code>dnsmasq&lt;/code> service, the two DNS services will no longer interfere with each other.
We have also decided to explicitly activate Dnsmasq only on the desired interface. File &lt;code>/etc/dnsmasq.conf&lt;/code>:&lt;/p>
&lt;pre tabindex="0">&lt;code>interface=enp0s31f6
&lt;/code>&lt;/pre>&lt;p>&lt;em>(this measure alone did not lead to success either - &lt;code>DNSMASQ_EXCEPT=&amp;quot;lo&amp;quot;&lt;/code> seems to be necessary!)&lt;/em>&lt;/p></description></item></channel></rss>