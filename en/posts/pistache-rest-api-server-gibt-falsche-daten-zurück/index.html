<!doctype html><html lang=en data-theme=dark><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>Pistache REST API Server Returns Incorrect Responses to Requests - ZERO GmbH Tech Blog</title>
<meta name=description content="Until a few hours ago we had to deal with a strange bug related to the C++ HTTP library &ldquo;Pistache&rdquo;, which could not be identified completely at first. Maybe we are not the only ones - so in this post we want to briefly present the setup and our fix."><link rel=icon type=image/x-icon href=https://blog.zero-iee.com/favicon.ico><link rel=apple-touch-icon-precomposed href=https://blog.zero-iee.com/favicon.png><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><script defer data-domain=blog.zero-iee.com src=https://analytics.zero-iee.com/js/script.js></script><link rel=stylesheet href=https://blog.zero-iee.com/css/style.min.930d4b2abd5c36f0b4decc538651a976d4e2c8f2f5c29312c354f3ca383468ae.css integrity="sha256-kw1LKr1cNvC03sxThlGpdtTiyPL1wpMSw1Tzyjg0aK4="><script src=https://blog.zero-iee.com/js/script.min.74bf1a3fcf1af396efa4acf3e660e876b61a2153ab9cbe1893ac24ea6d4f94ee.js type=text/javascript integrity="sha256-dL8aP88a85bvpKzz5mDodrYaIVOrnL4Yk6wk6m1PlO4="></script><meta property="og:url" content="https://blog.zero-iee.com/en/posts/pistache-rest-api-server-gibt-falsche-daten-zur%C3%BCck/"><meta property="og:site_name" content="ZERO GmbH Tech Blog"><meta property="og:title" content="Pistache REST API Server Returns Incorrect Responses to Requests"><meta property="og:description" content="Until a few hours ago we had to deal with a strange bug related to the C++ HTTP library &amp;ldquo;Pistache&amp;rdquo;, which could not be identified completely at first. Maybe we are not the only ones - so in this post we want to briefly present the setup and our fix.
"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-27T12:17:09+01:00"><meta property="article:modified_time" content="2023-01-27T12:17:09+01:00"><meta property="article:tag" content="Cpp"><meta property="article:tag" content="Pistache"><meta property="article:tag" content="Rest"><meta property="article:tag" content="Api"><meta property="article:tag" content="Javascript"><meta property="article:tag" content="Web"><meta name=twitter:card content="summary"><meta name=twitter:title content="Pistache REST API Server Returns Incorrect Responses to Requests"><meta name=twitter:description content="Until a few hours ago we had to deal with a strange bug related to the C++ HTTP library &ldquo;Pistache&rdquo;, which could not be identified completely at first. Maybe we are not the only ones - so in this post we want to briefly present the setup and our fix."></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header class=common-header><div class=header-top><div class=header-logo></div><h1 class=site-title><a href=/en>ZERO GmbH Tech Blog</a></h1><ul class=social-icons><li><a href=https://techhub.social/@zeroiee title=Mastodon rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></span></a></li><li><a href=https://github.com/zero-iee title=Github rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></li><li><a href=https://de.linkedin.com/company/zero-iee title=Linkedin rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></a></li></ul></div><nav></nav></header><main id=main tabindex=-1><article class="post h-entry"><div class=post-header><header><h1 class="p-name post-title">Pistache REST API Server Returns Incorrect Responses to Requests</h1><span><ul class=post-translations><li><a href=https://blog.zero-iee.com/posts/pistache-rest-api-server-gibt-falsche-daten-zur%C3%BCck/>DE</a></li><li>EN</li></ul></span></header></div><div class="content e-content"><p>Until a few hours ago we had to deal with a strange bug related to the C++ HTTP library &ldquo;<a href=https://pistacheio.github.io/pistache/>Pistache</a>&rdquo;, which could not be identified completely at first. Maybe we are not the only ones - so in this post we want to briefly present the setup and our fix.</p><p>The environment consists of a C++ based backend from which data is to be read via a REST API and displayed in a web browser.</p><p>The request of the data from the API is done via a Javascript. We work without a library - quite traditionally using <a href=https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/Using_XMLHttpRequest>XMLHttpRequest</a>. Since several different data sets are displayed on the website, several parallel <a href=https://de.wikipedia.org/wiki/Ajax_(programming)>Ajax</a> requests to the REST API are periodically formulated and transmitted in the background.</p><p><strong>The problem was that we - seemingly randomly - kept getting Ajax responses back that we had not requested in this context.</strong> For example, if a request for all available cars was sent, we got the response for the request for all available ships. In parallel, all available ships were also requested in the background - but just not in <em>the</em> function that was responsible for the cars. It seemed that the answers to HTTP requests were partially mixed.</p><p>The first assumption was that we had a bug in our Javascript and were overwriting variables with each other on simultaneous requests. However, after careful checking and clearly renaming the variables involved, we were able to rule that out.</p><p>A bug in the web browser that caused requests and responses to get mixed up? Unlikely. The problem occurred in both the Chromium and Firefox web browsers.</p><p>Then it had to be the backend. We started to examine the backend more closely. It turned out that the problems only occurred when a certain HTTP handler function was called. This custom function is called by the Pistache library when a request is received. Within the function, the parameters of the request can be checked and processed, and a suitable response can be formulated.</p><p>By gradually commenting out within the function and reducing it to the essentials (namely, sending a suitable response to the web browser), we were finally able to narrow down the problem.</p><p>Within the function there was the following code section:</p><pre tabindex=0><code>void ApiHandler::getVehicle(const Rest::Request &amp;request, Http::ResponseWriter response){
    json j;
    [...]

    if (myModel-&gt;getType() == &#34;car&#34;) {
    	[...]
        j[&#34;licensePlate&#34;] = car-&gt;getLicensePlate();
        j[&#34;owner&#34;] = car-&gt;getOwnerName();
        response.send(Http::Code::Ok, j.dump() + &#39;\n&#39;); // Respond with JSON string
    } else if (myModel-&gt;getType() == &#34;ship&#34;) {
        [...]
        j[&#34;homeCountry&#34;] = car-&gt;getHomeCountry();
        j[&#34;owner&#34;] = car-&gt;getOwnerName();
        response.send(Http::Code::Ok, j.dump() + &#39;\n&#39;); // Respond with JSON string
    } 
        
    response.send(Http::Code::Unprocessable_Entity);
}
</code></pre><p>Found the mistake? Quite simple: The intention was to return an &ldquo;Unprocessable_Entity&rdquo; error if the function was executed for a model other than a &ldquo;Car&rdquo; or &ldquo;Ship&rdquo; model. However, an <code>else</code> was forgotten. Correctly it should be like this:</p><pre tabindex=0><code>	else {
		response.send(Http::Code::Unprocessable_Entity);
	}
</code></pre><p>Omitting the <code>else</code> here is possible in cases where the further processing of the function is stopped by &ldquo;return&rdquo;. But not here - in our case the error leads to <code>response.send</code> being run twice in most cases.</p><p>The Pistache HTTP server does not seem to be able to cope with this and behaves <em>undefined</em>. We did not investigate further within the Pistache library, but it seemed worth mentioning that the library behaves unpredictably in such a case and apparently even mixes up responses to concurrent HTTP requests.</p><p>So if you are struggling with an uncontrollably behaving Pistache server, you might want to check your code for duplicate response.send() statements.</p></div><div class=post-info>By Thomas Leister<div class="post-date dt-published">2023-01-27</div><a class="post-hidden-url u-url" href=https://blog.zero-iee.com/en/posts/pistache-rest-api-server-gibt-falsche-daten-zur%C3%BCck/>https://blog.zero-iee.com/en/posts/pistache-rest-api-server-gibt-falsche-daten-zur%C3%BCck/</a>
<a href=https://blog.zero-iee.com/ class="p-name p-author post-hidden-author h-card" rel=me>Thomas Leister</a><div class=post-taxonomies><ul class=post-tags><li><a href=https://blog.zero-iee.com/en/tags/cpp/>#Cpp</a></li><li><a href=https://blog.zero-iee.com/en/tags/pistache/>#Pistache</a></li><li><a href=https://blog.zero-iee.com/en/tags/rest/>#Rest</a></li><li><a href=https://blog.zero-iee.com/en/tags/api/>#Api</a></li><li><a href=https://blog.zero-iee.com/en/tags/javascript/>#Javascript</a></li><li><a href=https://blog.zero-iee.com/en/tags/web/>#Web</a></li></ul></div></div></article></main><footer class=common-footer><ul class=language-select><li><a href=https://blog.zero-iee.com/posts/pistache-rest-api-server-gibt-falsche-daten-zur%C3%BCck/>Deutsch</a></li><li>English</li></ul><div class=common-footer-bottom><div class=copyright><p>Â© ZERO GmbH, ZERO GmbH Team, 2024 | <a href=/impressum/>Imprint</a> | <a href=/datenschutz/>Privacy</a><br>Powered by <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>, Markdown and Git<br>Theme <a target=_blank rel="noopener noreferrer" href=https://github.com/zero-iee/hugo-theme-anubis-zero>Anubis ZERO</a> based on <a href=https://github.com/Mitrichius/hugo-theme-anubis>Mitrichius/hugo-theme-anubis</a>.<br></p></div><script>const STORAGE_KEY="user-color-scheme",defaultTheme="dark-without-switcher";let currentTheme,switchButton,autoDefinedScheme=window.matchMedia("(prefers-color-scheme: dark)");const autoChangeScheme=e=>{currentTheme=e.matches?"dark":"light",document.documentElement.setAttribute("data-theme",currentTheme),changeButtonText()};document.addEventListener("DOMContentLoaded",function(){switchButton=document.querySelector(".theme-switcher"),currentTheme=detectCurrentScheme(),currentTheme=="dark"&&document.documentElement.setAttribute("data-theme","dark"),currentTheme=="auto"&&(autoChangeScheme(autoDefinedScheme),autoDefinedScheme.addListener(autoChangeScheme)),switchButton&&(changeButtonText(),switchButton.addEventListener("click",switchTheme,!1)),showContent()});function detectCurrentScheme(){return localStorage.getItem(STORAGE_KEY)?localStorage.getItem(STORAGE_KEY):defaultTheme?defaultTheme:window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":"light"}function changeButtonText(){switchButton&&(switchButton.textContent=currentTheme=="dark"?"Light theme":"Dark theme")}function switchTheme(){currentTheme=="dark"?(localStorage.setItem(STORAGE_KEY,"light"),document.documentElement.setAttribute("data-theme","light"),currentTheme="light"):(localStorage.setItem(STORAGE_KEY,"dark"),document.documentElement.setAttribute("data-theme","dark"),currentTheme="dark"),changeButtonText()}function showContent(){document.body.style.visibility="visible",document.body.style.opacity=1}</script></div><p class="h-card vcard"><a href=https://blog.zero-iee.com/ class="p-name u-url url fn" rel=me>ZERO GmbH Team</a></p></footer><a rel=me href=https://techhub.social/@zeroiee style=display:none>Mastodon</a></div></body></html>